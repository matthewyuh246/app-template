name: Security Scan

on:
  schedule:
    - cron: "0 2 * * 1" # æ¯Žé€±æœˆæ›œ 2:00 AM (JST 11:00 AM)
  workflow_dispatch:
    inputs:
      scan_type:
        description: "Select scan type"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - dependencies-only
          - secrets-only
          - docker-only

env:
  NODE_VERSION: "18"
  GO_VERSION: "1.24"

jobs:
  # ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
  dependency-scan:
    if: contains(github.event.inputs.scan_type, 'dependencies') || github.event.inputs.scan_type == 'all' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Go vulnerability check (govulncheck)
        run: |
          echo "ðŸ” Installing govulncheck..."
          go install golang.org/x/vuln/cmd/govulncheck@latest

          echo "ðŸ” Scanning Go dependencies for vulnerabilities..."
          cd backend
          $(go env GOPATH)/bin/govulncheck ./...

      - name: Node.js vulnerability check (npm audit)
        run: |
          echo "ðŸ” Installing Node.js dependencies..."
          cd frontend
          npm ci --prefer-offline --no-audit

          echo "ðŸ” Scanning Node.js dependencies for vulnerabilities..."
          npm audit --audit-level moderate --json > ../npm-audit-results.json || true

          # çµæžœã‚’è¡¨ç¤º
          if [ -s ../npm-audit-results.json ]; then
            echo "âš ï¸ Vulnerabilities found:"
            cat ../npm-audit-results.json | jq '.vulnerabilities // empty'
          else
            echo "âœ… No vulnerabilities found"
          fi

      - name: Upload audit results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: vulnerability-scan-results
          path: npm-audit-results.json
          retention-days: 30

  # åŒ…æ‹¬çš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ (Trivy)
  trivy-scan:
    if: contains(github.event.inputs.scan_type, 'all') || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH,MEDIUM"

      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

      - name: Run Trivy for readable output
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "table"
          output: "trivy-results.txt"

      - name: Upload readable Trivy results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: trivy-scan-results
          path: trivy-results.txt
          retention-days: 30

  # ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³
  secrets-scan:
    if: contains(github.event.inputs.scan_type, 'secrets') || github.event.inputs.scan_type == 'all' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å…¨å±¥æ­´å–å¾—

      - name: Run TruffleHog secrets scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

  # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ã‚­ãƒ£ãƒ³
  docker-scan:
    if: contains(github.event.inputs.scan_type, 'docker') || github.event.inputs.scan_type == 'all' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker images
        run: |
          echo "ðŸ³ Building Docker images for security scan..."
          docker build -f backend/Dockerfile -t app-backend:security-scan ./backend
          docker build -f frontend/Dockerfile -t app-frontend:security-scan ./frontend

      - name: Scan backend Docker image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "app-backend:security-scan"
          format: "sarif"
          output: "trivy-backend-image.sarif"

      - name: Scan frontend Docker image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "app-frontend:security-scan"
          format: "sarif"
          output: "trivy-frontend-image.sarif"

      - name: Upload Docker scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: "trivy-backend-image.sarif"

      - name: Upload Docker scan results (Frontend)
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: "trivy-frontend-image.sarif"

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  security-report:
    needs: [dependency-scan, trivy-scan, secrets-scan, docker-scan]
    if: always() && (github.event_name == 'schedule' || github.event.inputs.scan_type == 'all')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Generate security report
        run: |
          echo "# ðŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ãƒ¬ãƒãƒ¼ãƒˆ" > security-report.md
          echo "**å®Ÿè¡Œæ—¥æ™‚:** $(date)" >> security-report.md
          echo "" >> security-report.md

          echo "## ðŸ“Š ã‚¹ã‚­ãƒ£ãƒ³çµæžœã‚µãƒžãƒªãƒ¼" >> security-report.md
          echo "- âœ… ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³: å®Œäº†" >> security-report.md
          echo "- âœ… Trivyã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³: å®Œäº†" >> security-report.md
          echo "- âœ… ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³: å®Œäº†" >> security-report.md
          echo "- âœ… Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ã‚­ãƒ£ãƒ³: å®Œäº†" >> security-report.md
          echo "" >> security-report.md

          echo "## ðŸ”— è©³ç´°çµæžœ" >> security-report.md
          echo "è©³ç´°ãªçµæžœã¯ä»¥ä¸‹ã®Artifactsã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ï¼š" >> security-report.md
          echo "- vulnerability-scan-results" >> security-report.md
          echo "- trivy-scan-results" >> security-report.md
          echo "" >> security-report.md

          echo "## ðŸŽ¯ æŽ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³" >> security-report.md
          echo "1. Critical/Highè„†å¼±æ€§ã¯å„ªå…ˆçš„ã«ä¿®æ­£" >> security-report.md
          echo "2. ä¾å­˜é–¢ä¿‚ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’æ¤œè¨Ž" >> security-report.md
          echo "3. ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¼æ´©ãŒã‚ã‚‹å ´åˆã¯å³åº§ã«å¯¾å¿œ" >> security-report.md

      - name: Upload security report
        uses: actions/upload-artifact@v3
        with:
          name: security-report
          path: security-report.md
          retention-days: 90
